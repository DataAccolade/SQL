/*
Deployment script for test

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "test"
:setvar DefaultFilePrefix "test"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering [Fwk].[usp_Framework_200_Master]...';


GO
----- :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
----- FrmWrk: Nik - Shahriar Nikkhah               Date: 2022-09-21	Time: 23:04
----- Author: Enzo - Parsa Bahrami                 Date: 2023-01-25	Time: 20:36
----- 
----- Input :
----- 
----- Output :
----- 
----- Description : 
----- 
----- Benchmark : 
----- 
----- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
----- Revision History : For the next section please add : Your name , Date , what was modified or added.
----- 					 Add reference number or reference an emails subject.
----- 
----- 
----- :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
-----   This script is intended only as a supplement to demos and lectures
-----   given by "Nik - Shahriar Nikkhah" and/or "Enzo - Parsa Bahrami"
-----   
-----   THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF 
-----   ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED 
-----   TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, NON-INFRINGMENT AND/OR FITNESS FOR A
-----   PARTICULAR PURPOSE.
----- :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
--USE [test]
--GO
--;

-------************************************************************************************  
----- Primary Tests/Evaluation
-------************************************************************************************  
/*
SELECT * FROM sys.Objects WHERE name Like  '%usp_Framework_%'
SELECT * FROM sys.Objects WHERE name = 'usp_Framework_200_Master'
*/

-------************************************************************************************  
----- Cleanup
-------************************************************************************************ 
----- DROP PROCEDURE IF EXISTS [Fwk].[usp_Framework_200_Master]
--IF OBJECT_ID ('[Fwk].[usp_Framework_200_Master]') IS NOT NULL AND 2 = 2 --( 2=2 is a Safety net)
--	DROP PROCEDURE [Fwk].[usp_Framework_200_Master]
--GO;

-------************************************************************************************  
----- Extra Settings
-------************************************************************************************  
--SET ANSI_NULLS ON
--GO
--;

--SET QUOTED_IDENTIFIER ON
--GO
--;


-----************************************************************************************  
----- Create object (Table/View/uSP/...)
-----************************************************************************************  
ALTER PROCEDURE [Fwk].[usp_Framework_200_Master]
(
		@Parent_GuidId		uniqueIdentifier	--	This is the ADF RunID Guid_Id
	,	@ObjectTimeStamp	DateTime			--	Used to track ETL loads
)
AS
BEGIN
	SET NOCOUNT ON;
	DECLARE @Object_GuidId	uniqueIdentifier	=	NEWID()
	DECLARE @CurrentSPName  nVarChar(100)		=	OBJECT_NAME(@@PROCID)
	DECLARE @LogMessage		nVarChar(200) 		=	CAST(N'' AS nVarChar(200))

	BEGIN TRY
		BEGIN TRANSACTION
			
			-- For test only --- SET @LogMessage = 'Error in SP XXXXXXX '
			-- For test only --- SELECT 1/0 as test , * FROM [Fwk].[Framework]

			----- Internal Custom Logging
			----- EXEC usp_Insert_Batch_log ( 'Start SP' , @CurrentSPName , GetDate() , @Parent_GuidId	, @Object_GuidId )

			---=======================================================================
			--- Strat code 
			---=======================================================================
			-- SET @LogMessage = 'Error in TRUNCATE'
			-- EXEC usp_Framework_100_TRUNCATE @Object_GuidId , @ObjectTimeStamp;

			-- SET @LogMessage = 'Error in BusinessLogic1'
			-- EXEC usp_Framework_300_BusinessLogic1 @Object_GuidId , @ObjectTimeStamp;

			-- SET @LogMessage = 'Error in BusinessLogic2'
			-- EXEC usp_Framework_310_BusinessLogic2 @Object_GuidId , @ObjectTimeStamp;

			-- SET @LogMessage = 'Error in UPDATE'
			-- EXEC usp_Framework_810_UPDATE @Object_GuidId , @ObjectTimeStamp;

			-- SET @LogMessage = 'Error in INSERT'
			-- EXEC usp_Framework_820_INSERT @Object_GuidId , @ObjectTimeStamp;

			-- SET @LogMessage = 'Error in INSERT'
			-- EXEC usp_Framework_830_UPSERT @Object_GuidId , @ObjectTimeStamp;

			---=======================================================================
			--- END code 
			---=======================================================================
			
			----- Internal Custom Logging
			----- EXEC usp_Insert_Batch_log ( 'End SP' , @CurrentSPName , GetDate(), @Parent_GuidId	, @Object_GuidId )
		COMMIT 
	END TRY
	
	BEGIN CATCH
		----- Internal Custom Logging
		----- EXEC usp_Insert_Batch_log (ErrorNumber, MSErrorMsg + @LogMessage , @CurrentSPName, @Parent_GuidId	, @Object_GuidId )
		----- ;
		-- For test only --- SELECT @LogMessage Error , @CurrentSPName PRODName
		ROLLBACK
	END CATCH 
END
GO
----- :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
----- FrmWrk: Nik - Shahriar Nikkhah               Date: 2022-09-21	Time: 23:04
----- Author: Enzo - Parsa Bahrami                 Date: 2023-01-18	Time: 21:43
----- 
----- Input :
----- 
----- Output :
----- 
----- Description : 
----- 
----- Benchmark : 
----- 
----- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
----- Revision History : For the next section please add : Your name , Date , what was modified or added.
----- 					 Add reference number or reference an emails subject.
----- 
----- 
----- :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
-----   This script is intended only as a supplement to demos and lectures
-----   given by "Nik - Shahriar Nikkhah" and/or "Enzo - Parsa Bahrami"
-----   
-----   THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF 
-----   ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED 
-----   TO THE IMPLIED WARRANTIES OF MERCHANTABILITY, NON-INFRINGMENT AND/OR FITNESS FOR A
-----   PARTICULAR PURPOSE.
----- :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

-- ****************************************************************************
-- Call Stored Procedures
-- ****************************************************************************

--Examples
--:r "..\010-DatabaseAndSchemas\010-0030 UpdateDBAttributes.sql"
--:r "..\010-DatabaseAndSchemas\010-0115 CloneFwTables.sql"
--:r ".\060-0010 CreateAndSeedDimDate.sql"
GO

GO
PRINT N'Update complete.';


GO
